- hosts: all
  become: yes
  tasks:

    - name: prep for pulling docker images
      vars:
        pipenv_file_dir: '/vagrant/customizations'
      block:

        - name: installing pipenv
          pip:
            name: pipenv
            executable: pip3

        - name: installing python deps with pipenv
          # modified from: https://github.com/pypa/pipenv/issues/363#issuecomment-420936475
          command: 'pipenv install --deploy --system --skip-lock'
          args:
            chdir: '{{ pipenv_file_dir }}'
          changed_when: False


    - name: pulling docker images
      vars:
        docker_cmd_path: '/snap/bin/docker'
      block:

        - name: handling docker pathing....
          block:
            - name: adding images wanted to register
              args:
                executable: /bin/bash
              # specify the parenthesis in the bash shell so that all output is directed together from all commands
              #   so, all images are outputed to stdout_lines
              # weird curely braces is because of this:
              #   https://stackoverflow.com/questions/32279519/escaping-double-curly-braces-in-ansible#answer-32283447
              shell: |
                function docker_search(){
                  docker_image_owner="${1}"
                  dio="${docker_image_owner}"
                  docker_cmd='{{ docker_cmd_path }}'
                  if [[ -n "${2}" ]] ; then
                     ${docker_cmd} search --format '{{ '{{' }} .Name {{ '}}' }}' "${dio}" | grep "^${dio}/" | grep -vE "${2}"
                  else
                    ${docker_cmd} search --format '{{ '{{' }} .Name {{ '}}' }}' "${dio}" | grep "^${dio}/"
                  fi
                }
                docker_owners=( 'gh0s7:' 'elrey741:pipenv|python' )
                (
                  for owner in "${docker_owners[@]}" ; do
                    docker_search "${owner%:*}" "${owner#*:}"
                  done
                )
              register: docker_images
              changed_when: False

          rescue:

            - name: adding images wanted to register
              args:
                executable: /bin/bash
              # specify the parenthesis in the bash shell so that all output is directed together from all commands
              #   so, all images are outputed to stdout_lines
              # weird curely braces is because of this:
              #   https://stackoverflow.com/questions/32279519/escaping-double-curly-braces-in-ansible#answer-32283447
              shell: |
                function docker_search(){
                  docker_image_owner="${1}"
                  dio="${docker_image_owner}"
                  docker_cmd="$(which docker)"
                  if [[ -n "${2}" ]] ; then
                     ${docker_cmd} search --format '{{ '{{' }} .Name {{ '}}' }}' "${dio}" | grep "^${dio}/" | grep -vE "${2}"
                  else
                    ${docker_cmd} search --format '{{ '{{' }} .Name {{ '}}' }}' "${dio}" | grep "^${dio}/"
                  fi
                }
                docker_owners=( 'gh0s7:' 'elrey741:pipenv|python' )
                (
                  for owner in "${docker_owners[@]}" ; do
                    docker_search "${owner%:*}" "${owner#*:}"
                  done
                )
              register: docker_images
              changed_when: False

        # - debug:
        #     var: docker_images

        - name: pulling all images
          docker_image:
            name: '{{ item }}'
            source: pull
          loop: '{{ docker_images.stdout_lines }}'
